<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>CRUD de Alunos</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    input, select {
      display: block;
      margin: 5px 0;
      padding: 5px;
      width: 300px;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    img {
      max-width: 60px;
    }
    
    .form-grid {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .form-grid > div {
      display: flex;
      flex-direction: line;
      gap: 20px;
    }
  </style>
</head>
<body>
  <h1>Alunos</h1>
  <button onclick="carregarAlunos()">Carregar Alunos</button>

  <div class="form-grid">
    <div>
      <input id="Matricula" placeholder="Matrícula (9 dígitos)">
      <input id="CPF" placeholder="CPF (11 dígitos)">
      <input id="Nome" placeholder="Nome completo">
      <input id="Email" type="email" placeholder="Email">
      <input id="DataDeNascimento" type="date">
    </div>
    <div>
      <input id="Idade" type="number" placeholder="Idade">
      <input id="Status" placeholder="Status (Ativo/Inativo...)">
      <input id="IRA" type="number" step="0.0001" placeholder="IRA (0 a 5)">
      <input id="Integralizacao" type="number" step="0.01" placeholder="Integralização (%)">
      <input id="FotoPerfil" type="file" accept="image/*">
    </div>
  </div>
  <button onclick="criarOuAtualizarAluno()">Salvar</button>

  <table>
    <thead>
      <tr>
        <th>Foto</th>
        <th>Matrícula</th>
        <th>CPF</th>
        <th>Nome</th>
        <th>Email</th>
        <th>Data de Nascimento</th>
        <th>Idade</th>
        <th>Status</th>
        <th>IRA</th>
        <th>Integralização</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tabelaAlunos"></tbody>
  </table>

  <script>
    const API_URL = 'http://localhost:3000/alunos';

    let fotoBase64 = null;

    document.getElementById('FotoPerfil').addEventListener('change', function () {
      const file = this.files[0];
      const reader = new FileReader();
      reader.onload = function () {
        fotoBase64 = reader.result.split(',')[1]; // remove o prefixo "data:image/...;base64,"
      };
      if (file) {
        reader.readAsDataURL(file);
      }
    });

    async function carregarAlunos() {
      const res = await fetch(API_URL);
      const alunos = await res.json();

      const tabela = document.getElementById('tabelaAlunos');
      tabela.innerHTML = '';

      alunos.forEach(aluno => {
        const linha = document.createElement('tr');
        const img = aluno.fotoperfil
          ? `<img src="data:image/png;base64,${aluno.fotoperfil}">`
          : '';

        linha.innerHTML = `
          <td>${img}</td>
          <td>${aluno.matricula}</td>
          <td>${aluno.cpf}</td>
          <td>${aluno.nome}</td>
          <td>${aluno.email}</td>
          <td>${aluno.datadenascimento}</td>
          <td>${aluno.idade}</td>
          <td>${aluno.status}</td>
          <td>${aluno.ira}</td>
          <td>${aluno.integralizacao}</td>
          <td>
            <button onclick='editarAluno(${JSON.stringify(aluno)})'>Editar</button>
            <button onclick="deletarAluno('${aluno.matricula}')">Excluir</button>
          </td>
        `;
        tabela.appendChild(linha);
      });
    }

    async function criarOuAtualizarAluno() {
      const aluno = {
      Matricula: document.getElementById('Matricula').value,
      CPF: document.getElementById('CPF').value,
      Nome: document.getElementById('Nome').value,
      Email: document.getElementById('Email').value,
      DataDeNascimento: document.getElementById('DataDeNascimento').value || null,
      Idade: parseInt(document.getElementById('Idade').value),
      Status: document.getElementById('Status').value,
      IRA: parseFloat(document.getElementById('IRA').value),
      Integralizacao: parseFloat(document.getElementById('Integralizacao').value)
    };

    if (fotoBase64) {
      aluno.FotoPerfil = fotoBase64;
    }

      const existe = await fetch(`${API_URL}/${aluno.Matricula}`);
      if (existe.ok) {
        await fetch(`${API_URL}/${aluno.Matricula}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(aluno)
        });
      } else {
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(aluno)
        });
      }

      limparCampos();
      carregarAlunos();
    }

    function editarAluno(aluno) {
      document.getElementById('Matricula').value = aluno.matricula;
      document.getElementById('CPF').value = aluno.cpf;
      document.getElementById('Nome').value = aluno.nome;
      document.getElementById('Email').value = aluno.email;
      document.getElementById('DataDeNascimento').value = aluno.datadenascimento?.split('T')[0] || '';
      document.getElementById('Idade').value = aluno.idade || '';
      document.getElementById('Status').value = aluno.status;
      document.getElementById('IRA').value = aluno.ira || '';
      document.getElementById('Integralizacao').value = aluno.integralizacao || '';
    }

    async function deletarAluno(matricula) {
      if (confirm('Deseja mesmo excluir?')) {
        await fetch(`${API_URL}/${matricula}`, { method: 'DELETE' });
        carregarAlunos();
      }
    }

    function limparCampos() {
      ['Matricula','CPF','Nome','Email','DataDeNascimento','Idade','Status','IRA','Integralizacao'].forEach(id => {
        document.getElementById(id).value = '';
      });
      fotoBase64 = null;
    }

    carregarAlunos();
  </script>
</body>
</html>
